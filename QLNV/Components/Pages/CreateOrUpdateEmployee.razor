@using QLNV.Enum
@using QLNV.Services
@using QLNV.ViewModels
@inject ISnackbar Snackbar
@inject EmployeeService EmployeeService

<EditForm Model="@model" OnValidSubmit="OnValidSubmit">
  <MudDialog>
    <DialogContent>
      <DataAnnotationsValidator />
      <MudGrid Class="mb-5">
        <MudItem xs="9">
          <MudTextField @bind-Value="model.FullName"
                        Label="Họ Và Tên"
                        Variant="Variant.Outlined"
                        For="@(() => model.FullName)"
                        ShrinkLabel></MudTextField>
        </MudItem>
        <MudItem xs="9">
          <MudTextField @bind-Value="model.Age"
                        Label="Tuổi"
                        Variant="Variant.Outlined"
                        For="@(() => model.Age)"
                        ShrinkLabel></MudTextField>
        </MudItem>
      </MudGrid>
      <MudDatePicker Class="mb-5" Variant="Variant.Outlined"
                     Label="Ngày Sinh"
                     @bind-Value="_date"/>

      <MudTextField Class="mb-5" @bind-Value="model.Department"
                    Variant="Variant.Outlined"
                    Label="Phòng Ban"
                    For="@(() => model.Department)"
                    ShrinkLabel></MudTextField>

      <MudTextField Class="mb-5" @bind-Value="model.PhoneNumber"
                    Variant="Variant.Outlined"
                    Label="Số Điện Thoại"
                    For="@(() => model.PhoneNumber)"
                    ShrinkLabel></MudTextField>
    </DialogContent>

    <DialogActions>
      <MudButton OnClick="Cancel">Thoát</MudButton>
      <MudButton ButtonType="ButtonType.Submit" Color="Color.Primary">Lưu</MudButton>
    </DialogActions>

  </MudDialog>
</EditForm>

@code {
  [Parameter]
  public UIActionEnum Action { get; set; } = UIActionEnum.Insert;

  // [Parameter]
  // public UIActionEnum Action { get; set; } = UIActionEnum.Insert;

  [CascadingParameter]
  private IMudDialogInstance MudDialog { get; set; }

  [Parameter]
  public EmployeeViewModel model { get; set; } = new EmployeeViewModel();
  [Parameter]
  public DateTime? _date { get; set; } = DateTime.Today;

  private async Task OnValidSubmit(EditContext editContext)
  {
    if (_date is not null )
    {
      model.DateOfBirth = _date.Value;
    }

    if (Action == UIActionEnum.Insert)
    {
      CreateEmployee();
    }
    else if (Action == UIActionEnum.Update)
    {
      UpdateEmployee();
    }

  }

  private void CreateEmployee()
  {
    var result = EmployeeService.CreateEmployee(model);
    if (result)
    {
      Snackbar.Add("Đã Thêm Thành Công", Severity.Success);
      MudDialog.Close();
    }
    else
    {
      Snackbar.Add("Không Thể Thêm Thông Tin. Vui Lòng Kiểm Tra Lại", Severity.Error);
    }
  }

  private void UpdateEmployee()
  {
    var result = EmployeeService.UpdateEmployee(model);
    if (result)
    {
      Snackbar.Add("Đã Sửa Thành Công", Severity.Success);
      MudDialog.Close();
    }
    else
    {
      Snackbar.Add("Không Thể Sửa Thông Tin. Vui Lòng Kiểm Tra Lại", Severity.Error);
    }
  }

  private void Cancel()
  {
    MudDialog.Cancel();
  }

}